# ğŸ—ï¸ ARCHITECTURE DIAGRAM - Beat Upload System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT (Browser)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  1. User accesses: /admin/beats/{id}/upload                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚     â”‚  AdminLayout (Protection check)          â”‚                   â”‚
â”‚     â”‚  â”œâ”€ useAuth() â†’ Check user.role === 'admin'                  â”‚
â”‚     â”‚  â””â”€ If not admin â†’ Redirect /auth/login  â”‚                   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â–¼                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚     â”‚  Upload Page Component                    â”‚                   â”‚
â”‚     â”‚  â”œâ”€ Fetch beat data (GET /api/admin/beats/{id})              â”‚
â”‚     â”‚  â”œâ”€ Display 3 drag & drop zones          â”‚                   â”‚
â”‚     â”‚  â”œâ”€ Validate files (client-side)         â”‚                   â”‚
â”‚     â”‚  â””â”€ On submit:                            â”‚                   â”‚
â”‚     â”‚     1. Create FormData                    â”‚                   â”‚
â”‚     â”‚     2. POST /api/beats/{id}/upload        â”‚                   â”‚
â”‚     â”‚     3. Show progress bars                 â”‚                   â”‚
â”‚     â”‚     4. Handle response                    â”‚                   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                         â”‚                                           â”‚
â”‚                         â”‚ POST FormData                             â”‚
â”‚                         â”‚ (mp3, wav, stems)                         â”‚
â”‚                         â”‚ + JWT Token                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NEXT.JS API LAYER                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Route: /api/beats/[id]/upload/route.ts                             â”‚
â”‚                                                                      â”‚
â”‚  1. AUTHENTICATION                                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚     â”‚ getAdminFromRequest(request)      â”‚                          â”‚
â”‚     â”‚ â”œâ”€ Extract Bearer token           â”‚                          â”‚
â”‚     â”‚ â”œâ”€ Verify JWT                     â”‚                          â”‚
â”‚     â”‚ â””â”€ Check role === 'admin'         â”‚                          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚              â”‚                                                      â”‚
â”‚              â–¼ (authorized)                                         â”‚
â”‚                                                                      â”‚
â”‚  2. VALIDATION                                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚     â”‚ Parse FormData                    â”‚                          â”‚
â”‚     â”‚ For each file (mp3, wav, stems):  â”‚                          â”‚
â”‚     â”‚  â”œâ”€ Check extension (.mp3, .wav, .zip)                       â”‚
â”‚     â”‚  â”œâ”€ Check size (50MB, 200MB, 500MB)                          â”‚
â”‚     â”‚  â””â”€ Return errors if invalid      â”‚                          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚              â”‚                                                      â”‚
â”‚              â–¼ (valid files)                                        â”‚
â”‚                                                                      â”‚
â”‚  3. PROCESSING                                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚     â”‚ For each file:                    â”‚                          â”‚
â”‚     â”‚  1. Convert to Buffer             â”‚                          â”‚
â”‚     â”‚  2. Convert to Base64 Data URI    â”‚                          â”‚
â”‚     â”‚  3. Call uploadFileToCloudinary() â”‚                          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚              â”‚                                                      â”‚
â”‚              â–¼                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Base64 Data URI + Metadata
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLOUDINARY API                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  cloudinary.uploader.upload(dataUri, options)                       â”‚
â”‚                                                                      â”‚
â”‚  Options:                                                           â”‚
â”‚   â”œâ”€ folder: "isma-files/beats/{beatId}"                            â”‚
â”‚   â”œâ”€ public_id: "{beatId}_mp3" | "_wav" | "_stems"                  â”‚
â”‚   â”œâ”€ resource_type: "video" (mp3/wav) | "raw" (zip)                 â”‚
â”‚   â””â”€ overwrite: true                                                â”‚
â”‚                                                                      â”‚
â”‚  Processing:                                                        â”‚
â”‚   1. Decode Base64                                                  â”‚
â”‚   2. Store file in cloud storage                                    â”‚
â”‚   3. Generate secure_url                                            â”‚
â”‚   4. Return upload result                                           â”‚
â”‚                                                                      â”‚
â”‚  Result:                                                            â”‚
â”‚   {                                                                 â”‚
â”‚     secure_url: "https://res.cloudinary.com/.../file.mp3",          â”‚
â”‚     public_id: "isma-files/beats/{id}/{id}_mp3",                    â”‚
â”‚     resource_type: "video",                                         â”‚
â”‚     ...                                                             â”‚
â”‚   }                                                                 â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Secure URLs
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MONGODB DATABASE                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Collection: beats                                                  â”‚
â”‚                                                                      â”‚
â”‚  Beat.findByIdAndUpdate({id}, {                                     â”‚
â”‚    $set: {                                                          â”‚
â”‚      "files.mp3": "https://res.cloudinary.com/.../mp3.mp3",         â”‚
â”‚      "files.wav": "https://res.cloudinary.com/.../wav.wav",         â”‚
â”‚      "files.stems": "https://res.cloudinary.com/.../stems.zip"      â”‚
â”‚    }                                                                â”‚
â”‚  })                                                                 â”‚
â”‚                                                                      â”‚
â”‚  Updated Document:                                                  â”‚
â”‚  {                                                                  â”‚
â”‚    _id: ObjectId("..."),                                            â”‚
â”‚    title: "My Beat",                                                â”‚
â”‚    files: {                                                         â”‚
â”‚      mp3: "https://res.cloudinary.com/.../mp3.mp3",    âœ“ UPDATED   â”‚
â”‚      wav: "https://res.cloudinary.com/.../wav.wav",    âœ“ UPDATED   â”‚
â”‚      stems: "https://res.cloudinary.com/.../stems.zip" âœ“ UPDATED   â”‚
â”‚    },                                                               â”‚
â”‚    ...                                                              â”‚
â”‚  }                                                                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Success Response
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RESPONSE TO CLIENT                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  {                                                                  â”‚
â”‚    success: true,                                                   â”‚
â”‚    message: "Upload terminÃ©",                                       â”‚
â”‚    uploadedUrls: {                                                  â”‚
â”‚      mp3: "https://res.cloudinary.com/.../mp3.mp3",                 â”‚
â”‚      wav: "https://res.cloudinary.com/.../wav.wav",                 â”‚
â”‚      stems: "https://res.cloudinary.com/.../stems.zip"              â”‚
â”‚    },                                                               â”‚
â”‚    beat: {                                                          â”‚
â”‚      _id: "...",                                                    â”‚
â”‚      title: "My Beat",                                              â”‚
â”‚      files: { ... }                                                 â”‚
â”‚    }                                                                â”‚
â”‚  }                                                                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT UPDATE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  1. Update upload states:                                           â”‚
â”‚     â”œâ”€ progress: 100%                                               â”‚
â”‚     â”œâ”€ status: 'success'                                            â”‚
â”‚     â””â”€ url: {cloudinary_url}                                        â”‚
â”‚                                                                      â”‚
â”‚  2. Show success animation (GSAP scale)                             â”‚
â”‚                                                                      â”‚
â”‚  3. Display success message                                         â”‚
â”‚                                                                      â”‚
â”‚  4. Redirect to /admin/beats                                        â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow Summary

```
User Action â†’ FormData Creation â†’ API Request (+ JWT)
    â†“
Authentication (JWT verify + admin check)
    â†“
Validation (size, extension)
    â†“
Buffer â†’ Base64 Conversion
    â†“
Cloudinary Upload (parallel for each file)
    â†“
Receive Secure URLs
    â†“
Update MongoDB (Beat.files)
    â†“
Return Success Response
    â†“
Client State Update + Animation
    â†“
Redirect to Beats List
```

---

## ğŸ›¡ï¸ Security Layers

```
Layer 1: Frontend (AdminLayout)
  â”œâ”€ useAuth() hook
  â”œâ”€ Check user exists
  â””â”€ Check role === 'admin'

Layer 2: API (route.ts)
  â”œâ”€ getAdminFromRequest()
  â”œâ”€ JWT token verification
  â””â”€ Role verification

Layer 3: Validation (route.ts)
  â”œâ”€ File extension check
  â”œâ”€ File size check
  â””â”€ MIME type validation (implicit)

Layer 4: Cloudinary (external)
  â”œâ”€ API key/secret verification
  â”œâ”€ Upload quotas
  â””â”€ Resource type enforcement
```

---

## ğŸ“¦ File Storage Structure

```
Cloudinary Console:
  isma-files/
    â””â”€â”€ beats/
        â”œâ”€â”€ {beat_id_1}/
        â”‚   â”œâ”€â”€ {beat_id_1}_mp3.mp3
        â”‚   â”œâ”€â”€ {beat_id_1}_wav.wav
        â”‚   â””â”€â”€ {beat_id_1}_stems.zip
        â”‚
        â”œâ”€â”€ {beat_id_2}/
        â”‚   â”œâ”€â”€ {beat_id_2}_mp3.mp3
        â”‚   â”œâ”€â”€ {beat_id_2}_wav.wav
        â”‚   â””â”€â”€ {beat_id_2}_stems.zip
        â”‚
        â””â”€â”€ ...

MongoDB:
  beats {
    _id: ObjectId("beat_id_1"),
    files: {
      mp3: "https://res.cloudinary.com/.../beat_id_1_mp3.mp3",
      wav: "https://res.cloudinary.com/.../beat_id_1_wav.wav",
      stems: "https://res.cloudinary.com/.../beat_id_1_stems.zip"
    }
  }
```

---

## ğŸ¨ UI State Machine

```
FileUploadState:
  idle â”€â”€â”€â”€â†’ uploading â”€â”€â”€â”€â†’ success
    â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â†’ error

Transitions:
  â€¢ idle â†’ uploading: User clicks "Uploader"
  â€¢ uploading â†’ success: API returns 200 with URLs
  â€¢ uploading â†’ error: API returns error OR validation fails
  â€¢ idle â†’ error: Client-side validation fails
  â€¢ success/error â†’ idle: User selects new file
```

---

**Architecture designed for scalability, security, and exceptional UX! ğŸš€**
